---
- name: Install kubelet and kubectl
  ansible.builtin.apt:
    name:
      - kubelet
      - kubectl
    state: present
    update_cache: yes
  become: true

- name: Enable and start kubelet
  ansible.builtin.systemd:
    name: kubelet
    enabled: yes
    state: started
  become: true

- name: Check if node is already part of the cluster
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kube_node_kubelet_conf
  become: true

- name: Join node to cluster
  ansible.builtin.command: "{{ hostvars['master']['kubeadm_join_command'] }}"
  when: not kube_node_kubelet_conf.stat.exists
  become: true

